<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Canvas-based image white removal</title>
  <style>
    body {
      font-family: Optima, Helvetica, sans-serif;
      background:
        -webkit-radial-gradient(black 15%, transparent 16%) 0 0,
        -webkit-radial-gradient(black 15%, transparent 16%) 8px 8px,
        -webkit-radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px,
        -webkit-radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;
      background:
        -moz-radial-gradient(black 15%, transparent 16%) 0 0,
        -moz-radial-gradient(black 15%, transparent 16%) 8px 8px,
        -moz-radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px,
        -moz-radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;
      background:
        radial-gradient(black 15%, transparent 16%) 0 0,
        radial-gradient(black 15%, transparent 16%) 8px 8px,
        radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px,
        radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;
      background-color: #282828;
      background-size: 16px 16px;
    }
    h2, #log { color: #fff; }
    h2 { margin-bottom: 0; }
    .controls { background: #ccc; padding: 10px; display: inline-block; margin-bottom: 0; border-radius: 5px }
    #threshold-value, #distance-value { width: 30px }
    #threshold-slider, #distance-slider { width: 300px }
    canvas { display: block }
    pre { background: #fff; display: inline-block; padding: 10px; box-shadow: 1px 1px 10px rgba(0,0,0,0.3); margin-top: 40px; border-radius: 5px }
  </style>
</head>
<body>
  <h2>Canvas-based image white removal</h2>
  <p class="controls">
    <label>
      Image:
      <select id="img-selector">
        <option value="../fixtures/kang.png">Kangaroo (540x307)</option>
        <option value="../fixtures/girl.jpg">Girl (1000x750)</option>
        <option value="../fixtures/balls.jpg">Balls (1280x768)</option>
        <option value="../fixtures/onion.jpg">Onion (1600x1067)</option>
        <option value="../fixtures/house.jpg">House (1600x1200)</option>
        <option value="../fixtures/ship.jpg">Ship (2560x1440)</option>
      </select>
    </label>
    <label>
      Threshold: <input type="range" value="30" min="0" max="255" id="threshold-slider">
      <input type="text" id="threshold-value" value="30">
    </label>
    <label>
      Distance: <input type="range" value="200" min="0" max="255" id="distance-slider">
      <input type="text" id="distance-value" value="200">
    </label>
  </p>
  <p id="log"></p>
  <canvas id="c"></canvas>
  <img src="../fixtures/kang.png" id="img" style="display:none">
  <pre>
var limit = 255 - threshold, r, g, b;

for (var i = 0, n = pix.length; i < n; i += 4) {
  
  r = pix[i];
  g = pix[i+1];
  b = pix[i+2];
      
  if (r > limit && 
      g > limit && 
      b > limit && 
      abs(r-g) < distance && 
      abs(r-b) < distance &&
      abs(g-b) < distance) {

    pix[i+3] = 1;
  }
}
  </pre>
  <script>
    window.onload = function() {
      
      var imgEl = document.getElementById('img');
      var canvasEl = document.getElementById('c');
      var canvasWidth;
      var canvasHeight;
      var ctx = canvasEl.getContext('2d');
      
      var whiteThresholdEl = document.getElementById('threshold-slider');
      var whiteThresholdValueEl = document.getElementById('threshold-value');
      var distanceEl = document.getElementById('distance-slider');
      var distanceValueEl = document.getElementById('distance-value');
      var logEl = document.getElementById('log');
      
      var abs = Math.abs;
      
      function logTime(time) {
        logEl.innerHTML = 'White removed in: ' + time + 'ms';
      }
      
      function render() {
        canvasWidth = canvasEl.width = imgEl.width;
        canvasHeight = canvasEl.height = imgEl.height;
        ctx.clearRect(0, 0, canvasWidth, canvasHeight);
        ctx.drawImage(imgEl, 0, 0);
        var timeTaken = removeWhite(+whiteThresholdEl.value, +distanceEl.value);
        logTime(timeTaken);
        whiteThresholdValueEl.value = whiteThresholdEl.value;
        distanceValueEl.value = distanceEl.value;
      }
      
      function removeWhite(threshold, distance) {
        var startTime = new Date();
        var imgData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
        var pix = imgData.data;
        var limit = 255 - threshold, r, g, b;
        
        for (var i = 0, n = pix.length; i < n; i += 4) {
          
          r = pix[i];
          g = pix[i+1];
          b = pix[i+2];
              
          if (r > limit && 
              g > limit && 
              b > limit && 
              abs(r-g) < distance && 
              abs(r-b) < distance &&
              abs(g-b) < distance) {

            pix[i+3] = 1;
          }
        }

        ctx.putImageData(imgData, 0, 0);
        var endTime = new Date() - startTime;
        
        return endTime;
      }
      
      document.getElementById('threshold-slider').onchange = render;
      document.getElementById('distance-slider').onchange = render;
      
      render();
      
      document.getElementById('img-selector').onchange = function() {
        imgEl.onload = render;
        imgEl.src = this.value;
      };
    };
  </script>
</body>
</html>
